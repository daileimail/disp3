#!/usr/bin/env node

var fs = require("fs");
var path = require("path");
var core = require("../src/core");

var libFile = require("../lib/nodejs/file");

var node = process.argv[0], //nodejs binary
		dispCmd = process.argv[1], //this file
		task = process.argv[2];

var configFile = "project.json";
var incFile = "";
if(!task)	task = "main";

if(!fs.existsSync(configFile)){
	console.error(configFile + " is not existed");
	process.exit(1);
}
var	config = libFile.readJSON(configFile);

if(fs.existsSync("./product.json")){
	config.task.product = libFile.readJSON("./product.json");
	if(config.task.product){
		if(!config.task.product.target) config.task.product.target = "product";
	}
}
var dispRoot;
if(process.env.dispRoot) dispRoot = path.resolve(process.env.dispRoot);
else dispRoot = path.resolve(path.dirname(dispCmd) + "/..");
config.root = dispRoot;

core.set(config);

var res = core.run(task);
console.log(config.task[task].target);
fs.writeFileSync(config.task[task].target + "/.result.json", JSON.stringify(res, undefined, 2));


