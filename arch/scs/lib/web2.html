^^local.panel = function(config){$$

^^}$$

^^local.form = function(config){
 if(!config.hasOwnProperty('prefix'))
  config.prefix = config.name + ".data.";
 
$$
^^if(config.tpl){$$
<script type="text/ng-template" id="^^=config.tpl$$">
^^}$$
<div class="row" style="padding:10px;">
<form role="form" style="padding:15px;max-width:400px;">
  <fieldset>
^^for(var fname in config.fields){var f=config.fields[fname];$$
 ^^if(f.type == "input"){$$
    <div class="form-group">
      <input style="min-width:100px" class="form-control" type="^^=f.inputtype || 'text'$$" ng-model="^^=config.prefix$$^^=f.name$$" placeholder="^^=f.text || f.name$$">
    </div>
 ^^}else if(f.type == "button"){if(!f.style) f.style = "default";$$
    <button class="btn btn-md btn-^^=f.style$$" ng-click="^^=f.click$$()">^^=f.text$$</button>
 ^^}$$
^^}$$
  </fieldset>
</form>
</div>
^^if(config.tpl){$$
</script>
^^}$$
^^}$$
^^local.makequery = function(config){$$
	<div class="row">
		<div class="col-sm-8">
			<div class="btn-group" role="group">
				<a class="btn btn-default" ng-click="^^=config.name$$.loadSave({})">all</a>
				<a ng-repeat="save in ^^=config.name$$.savequerys" class="btn btn-default" ng-click="^^=config.name$$.loadSave(save)">{{save.name}}</a>
			</div>
		</div>
		<div class="col-sm-4 text-right">
			<div class="btn-group" role="group">
				<a class="btn btn-default" uib-tooltip="搜索" ng-click="showquery=!showquery"><i class="fa fa-search"></i></a>
				<a class="btn btn-default" uib-tooltip="统计（TODO）" ng-click="showstat=!showstat"><i class="fa fa-calculator"></i></a>
			</div>
		</div>
		<div class="col-sm-6" ng-show="showsave" style="padding: 10px;border:1px;">
			<div class="form-group">
				<input class="form-control" placeholder="请为这次存储命名" ng-model="savename">
				<a class="form-control btn btn-default" ng-click="^^=config.name$$.save(savename)"></a>
			</div>
		</div>
		<div class="col-sm-6 borderbox" ng-show="showquery" style="padding: 10px;">
			<div class="btn-group" role="group">
			<a class="btn btn-default"><i class="fa fa-plus">user</i></a>
			<a class="btn btn-default" ng-click="^^=config.name$$.addRawQuery()"><i class="fa fa-plus"></i></a>
			<a class="btn btn-default" ng-click="^^=config.name$$.rawquerys = []">Clear</a>
			<a class="btn btn-default" ng-click="^^=config.name$$.refresh()">Go</a>
			<a class="btn btn-default" ng-click="^^=config.name$$.saveQuery()"><i class="fa fa-save"></i></a>
			<input class="form-control" ng-model="^^=config.name$$.savename" placeholder="标识">
			</div>
			<form class="form-inline">
				<div class="form-group" style="padding:10px" ng-repeat="rawquery in ^^=config.name$$.rawquerys track by $index">
					<select class="form-control" ng-model="rawquery.field" ng-options="key for key in ^^=config.name$$.fieldlist"></select>
					<select class="form-control" style="width:auto" ng-model="rawquery.op" ng-options="key for key in ^^=config.name$$.oplist"></select>
					<input type="text" class="form-control" placeholder="value" ng-model="rawquery.value">
					<a class="btn btn-default" ng-click="^^=config.name$$.rawquerys.splice($index, 1)"><i class="fa fa-minus"></i></a>
				</div>
			</form>
		</div>
		<div class="col-sm-6 borderbox" ng-show="showstat">
			TODO
		</div>
	</div>
^^}$$
^^local.table = function(config){$$
^^
if(config.withSchema){
	if (config.withSchema) {
		if(Object.keys(config.fields).length){
			for(var f in config.fields){
				$.append(config.fields[f], global.proto.schemas[config.withSchema].fields[f]);
			}
		}else{
			$.append(config.fields, global.proto.schemas[config.withSchema].fields);
		}
	}
}
$$
<div class="panel panel-primary">
<div class="panel-heading">^^=config.text || config.name$$</div>
<div class="panel-body">
<div class="col-sm-9">
^^local.makequery(config)$$
</div>
<div class="col-sm-3">
<div class="input-group">
  <input type="text" class="form-control" placeholder="page" ng-model="pageToGo">
  <span class="input-group-btn">
    <button class="btn btn-default" type="button" ng-click="^^=config.name$$.gotoPage(pageToGo)">Go!</button>
  </span>
</div>
<div class="col-sm-9">
</div>
</div>
<div class="col-sm-12 btn-group">
^^if(config.opt && config.opt.add){$$
  <button class="btn btn-default" ng-click="optAdd()">添加数据</button>
^^}$$
^^if(config.toolbar){
  for(var name in config.toolbar){
    var ele = config.toolbar[name];
    if(!ele.tag)ele.tag="button";
  $$<^^=ele.tag$$^^if(ele.attr){if(!ele.attr.class){$$ class="btn btn-default"^^}for(var attrname in ele.attr){$$^^= attrname$$="^^=ele.attr[attrname]$$"^^}}else{$$ class="btn btn-default"^^}$$>^^=ele.text||name$$</^^=ele.tag$$>^^}}$$
</div>

<div class="col-sm-6">
	<div class="form-inline" style="verical-align:middle;padding:0.2em 0;">
	<label style="font-weight:normal">Show <select class="form-control input-sm" ng-model="^^=config.name$$.perPage" ng-options="op for op in ^^=config.name$$.perPages"></select> entries</label>
	</div>
</div>
<div class="col-sm-6 text-right">
	^^pagenator(config)$$
</div>
  <div class="col-sm-12" style="overflow-x:auto;">
  <table class="table table-striped table-bordered" style="vertical-align:middle;"><thead>
 ^^for(var name in config.fields){var col = config.fields[name];$$
  ^^if(col.hidden){continue;}$$
  ^^if(col.type == 'func'){$$
  <th>^^=col.text || ""$$</th>
  ^^}else{$$
  <th><a style="padding: 0 5px;" ng-click="^^=config.name$$.changeSort('^^=name$$')"><i class="fa" ng-class="{'fa-sort-asc':^^=config.name$$.sort.^^=name$$ === 1,'fa-sort-desc': ^^=config.name$$.sort.^^=name$$ === -1,'fa-sort':!^^=config.name$$.sort.^^=name$$}"></i></a>^^=col.text||name$$<br/>^^=name$$</th>
  ^^}$$
 ^^}$$
 ^^if(config.opt){$$
  <th>opt</th>
  ^^}$$
  </thead>
  <tbody>
    <tr ng-repeat="row in ^^=config.name$$.data" onlastrepeat>
 ^^for(var name in config.fields){var col = config.fields[name];$$
 ^^if(!col.hidden){$$
 	<td>
  ^^if(col.type == 'func'){$$
	 ^^if(col.elements) for(var subname in col.elements){var sube = col.elements[subname];$$
    ^^if(sube.type == "button"){$$
     ^^
     var clickstr = "";
     if(sube.click){
      clickstr = 'ng-click="' + sube.click + '"';
     }
     var hrefstr = "";
     if(sube.href){
      hrefstr = 'ng-href="' + sube.href + '"';
     }
     $$
  		<a class="btn btn-xs btn-primary" ^^=clickstr$$ ^^=hrefstr$$>^^=sube.text || sube.name$$</a>
    ^^}$$
   ^^}$$
  ^^}else{$$
  ^^if(col.ondemand){$$
	<span class="glyphicon glyphicon-option-horizontal" ng-click="^^=config.name$$.showrow^^=name$$=true" ng-hide="^^=config.name$$.showrow^^=name$$"></span>
	<div ng-click="^^=config.name$$.showrow^^=name$$=false" ng-show="^^=config.name$$.showrow^^=name$$">^^bytype(col.type)$$</div>
  ^^}else if(col.href){$$
  <a ng-href="^^=col.href$${{row.^^=name$$}}">^^bytype(col.type)$$</a>
  ^^}else if(col.showuser){$$
  <a data-toggle="popover" class='showuser' data-container="body" data-placement="right" data-content="..." userid="{{row.^^=col.showuser$$}}">^^bytype(col.type)$$</a>
  ^^}else{
		bytype(col.type)
  }$$</td>
 ^^}}}$$
 ^^if(config.opt){$$
 <td>
    ^^if(config.opt.update){$$
      <button class="btn btn-primary" ng-click="optUpdate(row)">修改</button>
    ^^}$$
    ^^if(config.opt.delete){$$
      <button class="btn btn-primary" ng-click="optDelete(row)">删除</button>
    ^^}$$
    ^^for(var name in config.opt){if(name != "add" && name != "update" && name != "delete"){$$
      <button class="btn btn-primary"
      ^^for(var attr in config.opt[name].attr){var value = config.opt[name].attr[attr];$$
        ^^=attr$$="^^=value$$" 
        ^^}$$
        >^^= config.opt[name].text || name$$</button>
    ^^}}$$
  </td>
  ^^}$$
		</tr>
	</tbody>
</table>
  </div>
<div class="col-sm-6"><div style="padding:0.5em 0;">Showing {{^^=config.name$$.perPage*(^^=config.name$$.currPage-1)+1}} to {{^^=config.name$$.perPage*^^=config.name$$.currPage}} of {{^^=config.name$$.count}} entries</div></div>
<div class="col-sm-6 text-right">
	^^pagenator(config)$$
</div>
</div>
</div>


 ^^function bytype(type){$$
	^^if(type == "date"){$$
 			{{row.^^=name$$ | stddate}}
	^^}else if(type == "datetime"){$$
 			{{row.^^=name$$|date:'yy/MM/dd HH:mm'}}
  ^^}else{$$
 			{{row.^^=name$$}}
  ^^}$$
 ^^}$$

 ^^function pagenator(config){$$
<ul class="pagination" style="margin:2px 0;">
  <li><a ng-click="^^=config.name$$.gotoFirst()" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
  <li ng-class="{active: p===^^=config.name$$.currPage}" ng-repeat="p in ^^=config.name$$.adj()"><a style="cursor:pointer;" ng-click="^^=config.name$$.gotoPage(p)">{{p}}</a></li>
  <li><a ng-click="^^=config.name$$.gotoLast()" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
</ul>
 ^^}$$

^^}$$



