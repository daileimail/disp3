{
	"proto": {
		"uis": {
			"signin": {
				"text": "登录",
				"elements": {
					"sf": {
						"type": "form",
						"fields": {
							"email": {
								"type": "input",
								"inputtype": "text"
							},
							"password": {
								"type": "input",
								"inputtype": "password"
							},
							"submit": {
								"text": "登录",
								"type": "button",
								"style": "success",
								"click": "submit"
							}
						}
					},
					"submit": {
						"type": "method",
						"fields": [
							{
								"type": "req",
								"method": "post",
								"url": "/api/admin_signin",
								"data": "$scope.sf.data",
								"do": "auth.settoken(result.token);"
							},
							{
								"type": "req",
								"method": "postBearer",
								"url": "/api/admin_get",
								"do": "auth.setuser(result);$rootScope.user = auth.getuser();location = '/';"
							}
						]
					}
				}
			}
		},
		"schemas": {
			"adminquery": {
				"fields": {
					"adminin": {
						"type": "ObjectId"
					}
				}
			},
			"adminstat": {
				"fields": {
					"adminin": {
						"type": "ObjectId"
					}
				}
			},			
			"admin": {
				"seed": [
					{
						"email": "test",
						"password": "test",
						"token": "abcdef"
					}
				],
				"fields": {
					"email": {
						"type": "string",
						"text": "邮箱"
					},
					"password": {
						"encrypt": "bcrypt",
						"hidden": true
					},
					"token": {
						"type": "string",
						"hidden": true
					},
					"realname": {
            "text": "真实姓名",
            "type": "string",
            "basic": true
          },
					"modifytime": {
						"type": "datetime",
						"onmodify": true
					},
					"flags": {
						"type": "json"
					},
					"createtime": {
						"type": "datetime", 
						"default": 0 
					}
				}
			}
		},
		"apis": {
			"access": {
				"text": "获取数据库信息",
				"params": {
					"schema": {
						"isParams": true,
						"require": true
					},
					"method": {	
						"isParams": true,
						"require": true
					},
					"where": {
					},
					"options": {
					}
				},				
				"controllers": [
					{
						"type": "async",
						"method": "db.getModel(schema)[method]",
						"params": "where, options",
						"send": "result"
					}
				]
			},
			"export_file": {
				"text": "导出表格",
				"params": {
					"schema": {
						"isParams": true,
						"require": true
					},
					"method": {	
						"isParams": true,
						"require": true
					},
					"where": {
					},
					"options": {
					}
				}
			},
			"admin_save_query": {
				"params": {
					"schema": {						
					},
					"data": {
					},
					"_id": {
					}
				},
				"controllers": [
					{
						"check": {
							"!data.rawquerys || !data.rawquerys.length": "查询为空"
						}
					},
					{
						"type": "db",
						"schema": "adminquery",
						"method": "upsert",
						"where": "{name: data.name, adminid: req.user._id}",
						"set": "{schema: schema, rawquerys: data.rawquerys, sort: data.sort}",
						"send": "result"
					}
				],
				"midwares": ["auth"]
			},
			"admin_get_querys": {
				"params": {
					"schema": {
						"type": "string"
					}
				},
				"controllers": [
					{
						"type": "db",
						"schema": "adminquery",
						"method": "bselect",
						"where": "{adminid: req.user._id, schema: schema}",
						"send": "{data: result}"
					}
				],
				"midwares": ["auth"]
			},
			"admin_get_stats": {
			},
			"admin_save_stat": {
			},
			"admin_signin": {
				"text": "管理员登陆",
				"params": {
					"email": {
						"type": "string",
						"text": "邮箱",
						"required": true
					},
					"password": {
						"type": "string",
						"text": "密码",
						"required": true
					}
				},
				"controllers": [
					{
						"type": "db",
						"method": "select",
						"schema": "admin",
						"where": "{email: email}",
						"result": "user",
						"check": {
							"!user": "用户名不存在",
							"!libEncrypt.bcryptcompare(password, user.password)": "密码错误"
						}						
					},
					{
						"pre": "token = libRandom.hat();",
						"type": "db",
						"method": "update",
						"schema": "admin",
						"where": "{_id: user._id}",
						"set": "{token: token}",
						"send": "{token: token}"
					}
				]
			},
			"admin_get": {
				"text": "获取管理员信息",
				"controllers": [
					{
						"type": "db",
						"method": "select",
						"schema": "admin",
						"where": "{_id: req.user._id}",
						"do": "delete result.password;",
						"send": "result"
					}
				],
				"midwares": ["auth"]
			}
		}
	},
	"impl": {
		"databases":{
			"main": {
				"withSchemas": [
					"admin",
					"adminstat",
					"adminquery"
				]
			}
		}
	}
}
