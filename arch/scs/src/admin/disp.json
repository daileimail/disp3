{
	"proto": {
		"uis": {
			"admin_list": {
				"text": "管理员列表",
				"elements": {
					"admin": {
						"type": "table",
						"withSchema": "admin",
						"insert": 1,
						"update": 1
					}
				}
			},
			"signin": {
				"text": "登录",
				"elements": {
					"sf": {
						"type": "form",
						"fields": {
							"email": {
								"type": "input",
								"inputtype": "text",
								"model": "sf.email"
							},
							"password": {
								"text": "密码",
								"type": "input",
								"inputtype": "password",
								"model": "sf.password"
							},
							"submit": {
								"text": "登录",
								"type": "button",
								"style": "success",
								"click": "submit()"
							}
						}
					},
					"submit": {
						"type": "method",
						"fields": [{
							"type": "req",
							"method": "post",
							"url": "/api/admin_signin",
							"data": "$scope.sf",
							"do": "auth.settoken(result.token);"
						}, {
							"type": "req",
							"method": "postBearer",
							"url": "/api/admin_get",
							"do": "auth.setuser(result);$rootScope.user = auth.getuser();location = '/';"
						}]
					}
				}
			}
		},
		"schemas": {
			"adminquery": {
				"fields": {
					"adminin": {
						"type": "ObjectId"
					}
				}
			},
			"adminstat": {
				"fields": {
					"adminin": {
						"type": "ObjectId"
					}
				}
			},
			"admin": {
				"seed": [{
					"email": "test",
					"password": "test",
					"token": "abcdef"
				}, {
					"email": "test1",
					"password": "test1",
					"token": "abcdefg"
				}, {
					"email": "test2",
					"password": "test2",
					"token": "abcdefgh"
				}, {
					"email": "test3",
					"password": "test3",
					"token": "abcdefgi"
				}, {
					"email": "test4",
					"password": "test4",
					"token": "abcdefghij"
				}],
				"fields": {
					"email": {
						"type": "string",
						"text": "邮箱"
					},
					"password": {
						"type": "string",
						"encrypt": "bcrypt"
					},
					"token": {
						"type": "string",
						"hidden": true
					},
					"realname": {
						"text": "真实姓名",
						"type": "string",
						"basic": true
					},
					"createtime": {
						"type": "datetime",
						"nomanual": 1,
						"default": 0
					}
				}
			}
		},
		"apis": {
			"upload": {
				"text": "上传文件",
				"params": {
					"path1": {
						"isParams": 1
					},
					"path2": {
						"isParams": 1
					},
					"buffer": {
						"isMultipartFile": true,
						"required": true
					}
				},
				"controllers": [
					{
						"pre": "libFile.mkdirpSync(path1+'/'+path2)",
						"type": "raw",
						"do": "libFile.mvSync(buffer, path1+'/'+path2+'/'+path.basename(buffer))",
						"send": "{filename: path.basename(buffer)}"
					}
				],
				"midwares": [
					"auth", 
					"auths.checkflag('upload', '没有上传权限，请联系管理员开通')",
					"multipart('filecache')"
				]
			},
			"access": {
				"text": "获取数据库信息",
				"params": {
					"schema": {
						"isParams": true,
						"require": true
					},
					"method": {
						"isParams": true,
						"require": true
					},
					"by": {},
					"where": {},
					"options": {}
				},
				"controllers": [{
					"type": "async",
					"method": "Admin.access",
					"params": "schema, method, req.body, req.user",
					"send": "result"
				}],
				"midwares": ["auth"]
			},
			"stat": {
				"method": "get",
				"text": "导出表格",
				"params": {
					"statname": {
						"isParams": true,
						"require": true
					},
					"filename": {
						"isParams": true,
						"require": true
					}
				},
				"controllers": [
					{
						"type": "async",
						"method": "require('../controllers/stat')[statname]",
						"do": "res.header('content-type', 'application/csv');result.pipe(res)"
					}
				],
				"midwares": ["auth", "auths.checkflag('opstat')"]
			},
			"admin_save_query": {
				"params": {
					"schema": {},
					"data": {},
					"_id": {}
				},
				"controllers": [{
					"check": {
						"!data.rawquerys || !data.rawquerys.length": "查询为空"
					}
				}, {
					"type": "db",
					"schema": "adminquery",
					"method": "upsert",
					"where": "{name: data.name, adminid: req.user._id}",
					"set": "{schema: schema, rawquerys: data.rawquerys, sort: data.sort}",
					"send": "result"
				}],
				"midwares": ["auth"]
			},
			"admin_get_querys": {
				"params": {
					"schema": {
						"type": "string"
					}
				},
				"controllers": [{
					"type": "db",
					"schema": "adminquery",
					"method": "bselect",
					"where": "{adminid: req.user._id, schema: schema}",
					"send": "{data: result}"
				}],
				"midwares": ["auth"]
			},
			"admin_get_stats": {},
			"admin_save_stat": {},
			"admin_signin": {
				"text": "管理员登陆",
				"params": {
					"email": {
						"type": "string",
						"text": "邮箱",
						"required": true
					},
					"password": {
						"type": "string",
						"text": "密码",
						"required": true
					}
				},
				"controllers": [{
					"type": "db",
					"method": "select",
					"schema": "admin",
					"where": "{email: email}",
					"result": "user",
					"check": {
						"!user": "用户名不存在",
						"!libEncrypt.bcryptcompare(password, user.password)": "密码错误"
					}
				}, {
					"pre": "token = libRandom.hat();",
					"type": "db",
					"method": "update",
					"schema": "admin",
					"where": "{_id: user._id}",
					"set": "{token: token}",
					"send": "{token: token}"
				}]
			},
			"admin_get": {
				"text": "获取管理员信息",
				"controllers": [{
					"type": "db",
					"method": "select",
					"schema": "admin",
					"where": "{_id: req.user._id}",
					"do": "delete result.password;",
					"send": "result"
				}],
				"midwares": ["auth"]
			}
		}
	},
	"impl": {
		"databases": {
			"main": {
				"withSchemas": [
					"admin",
					"adminstat",
					"adminquery"
				]
			}
		}
	}
}
