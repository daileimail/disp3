{
	"proto": {
		"schemas": {
			"record_sms": {
				"fields": {
          "phone": {
						"type":"string",
						"index": 1
					},
					"tplid": {
						"type":"string"
					},
					"time": {
						"type": "datetime",
						"default": 0
					}
				}
			},
			"smstpl": {
				"fields": {
					"tplid": {
						"type":"string",
						"index": 1
					},
					"content": {
						"type":"string",
						"index": 1
					},
					"time": {
						"type": "datetime",
						"default": 0
					}
				}
			},
			"smscode": {
				"fields": {
          "phone": {
						"type":"string",
						"index": 1
					},
					"code": {
						"type":"string",
						"index": 1
					},
					"time": {
						"type": "datetime"
					}
				}
			},
			"record_user_signin": {
				
			},
			"invite": {
			},
			"channel": {				
			},
			"session": {
				"fields": {
          "session": {
            "text": "会话",
            "type": "string",
						"index": 1
          },
				  "device_token": {
            "text": "设备token",
            "type": "string"
          },
          "time": {
            "text": "时间",
            "type": "string"
          },
					"channel": {
            "text": "渠道",
            "type": "string"
          },
          "version": {
            "text": "版本号",
            "type": "string"
          }
				}
			},
			"user": {
				"fields": {					
					"phone": {
						"type": "string",
						"text": "手机号",
						"index": 1,
						"unique": true
					},
					"password": {
						"encrypt": "bcrypt",
						"hidden": true
					},
					"paypassword": {
						"encrypt": "bcrypt",
						"hidden": true
					},
					"token": {
						"type": "string",
						"hidden": true
					},
					"invite": {
						"text": "注册渠道",
						"type": "string"
					},
					"inviteby": {
						"text": "邀请人",
						"type": "ObjectId"
					},
					"invitecode": {
						"text": "邀请码",
						"type": "string"
					},
					"createtime": {
						"text": "注册时间",
						"type": "datetime", 
						"default": 0 
					}
				}
			}
		},
		"apis": {
			"sms_send_signup": {
				"text": "注册时发送验证码",
				"params": {
					"phone": {
						"required": true
					}
				},
				"controllers": [
					{
						"type": "db",
						"schema": "smscode",
						"method": "select",
						"where": "{phone: phone}",
						"check": {
							"result && new Date().getTime() - new Date(result.time).getTime() < 60000": "发送短信过于频繁"
						},
						"do": "var code = libRandom.genNum(4);"
					},
					{
						"type": "async",
						"method": "Sms.send",
						"params": "{phone: phone, code: code, tplid: 'code'}"
					},
					{
						"type": "db",
						"schema": "smscode",
						"method": "upsert",
						"where": "{phone: phone}",
						"set": "{code: code, time: new Date()}",
						"send": "result"
					}
				]
			},
			"sms_send_reg": {
				"text": "已注册用户发送验证码",
				"params": {
					"phone": {
						"required": true
					}
				}
			},
			"sms_verify": {
				"text": "校验验证码",
				"params": {
					"phone": {
						"required": true
					},
					"code": {
						"required": true
					}
				},
				"controllers": [
					{
						"type": "db",
						"method": "select",
						"schema": "smscode",
						"where": "{phone: phone, code: code}",
						"result": "sms",
						"check": {
							"!sms": "验证码错误",
							"new Date(sms.time).getTime() - new Date().getTime() > 60000*5": "验证码过期"
						},
						"send": "{success: true}"
					}
				]
			},
			"session_add": {
				"text": "用户上线时/进入app时调用, 原enter接口",
				"params": {
          "session": {
						"required": true
					},
          "device_token": {
            "required": true
          },
					"channel": {
            "text": "渠道",
            "required": true
          },
          "version": {
            "text": "版本号",
						"required": true
          },
					"userid": {
            "text": "用户id"
          }
				},
				"controllers": [
					{
						"type": "db",
						"schema": "session",
						"method": "insert",
						"doc": "{device_token: device_token, session: session, version: version, channel: channel, userid: userid}",
						"send": "{success: true}"
					}
				]
			},
			"session_supp": {
				"text": "发送用户体验数据, 原sendUserExp",
				"params": {
          "session": {
            "required": true
          },
          "index": {
            "required": true
          },
          "content": {
            "required": true
          },
          "userid": {
            "text": "用户id"
					}
        }
			},
			"user_signup": {
				"text": "用户注册",
				"params": {
					"phone": {
						"type": "string",
						"text": "手机号",
						"required": true
					},
					"password": {
						"type": "string",
						"text": "密码",
						"required": true
					},
					"session": {
						"type": "string",
						"text": "session",
						"required": true
					},
					"device_token": {
						"type": "string",
						"required": true
					},
					"invitecode": {
						"type": "string",
						"text": "邀请码"
					}
				},
				"controllers": [
					{
						"type": "db",
						"method": "select",
						"schema": "session",
						"where": "{session: session, device_token: device_token}",
						"result": "sessionres",
						"check": {
							"!sessionres": "非法注册"
						}
					},
					{
						"type": "db",
						"method": "select",
						"schema": "user",
						"where": "{phone: phone}",
						"result": "user",
						"check": {
							"user": {
								"message": "用户名已注册", 
								"code":1
							}
						}
					},
					{
						"type": "async",
						"method": "Invite.verify",
						"params": "invitecode",
						"result": "invite"
					},
					{
						"type": "db",
						"method": "insert",
						"schema": "user",
						"pre": "invite.phone = phone;invite.password=password;;invite.token=libRandom.hat();",
						"doc": "invite",
						"do": "invite._id = result.insertedId; if(checkpoints.signup) checkpoints.signup(invite);",
						"send": "invite"
					}					
				]
			},
			"user_signin": {
				"text": "用户登陆",
				"params": {
					"phone": {
						"type": "string",
						"text": "手机号",
						"required": true
					},
					"password": {
						"type": "string",
						"text": "密码",
						"required": true
					},
					"session": {
						"type": "string",
						"text": "session",
						"required": true
					},
					"device_token": {
						"type": "string",
						"required": true
					}
				},
				"controllers": [
					{
						"type": "db",
						"method": "select",
						"schema": "user",
						"where": "{phone: phone}",
						"result": "user",
						"check": {
							"!user": "用户名不存在",
							"!libEncrypt.bcryptcompare(password, user.password)": "密码错误"
						}
					},
					{
						"type": "db",
						"method": "update",
						"schema": "session",
						"where": "{session: session, device_token: device_token}",
						"set": "{userid: user._id}",
						"result": "sessionres",
						"check": {
							"!sessionres.n": "非法登陆"
						}
					},
					{
						"pre": "token = libRandom.hat();",
						"type": "db",
						"method": "update",
						"schema": "user",
						"where": "{_id: user._id}",
						"set": "{token: token}",
						"send": "{token: token, _id: user._id}"
					}
				]
			},
			"user_get": {
				"text": "获取用户信息",
				"controllers": [
					{
						"type": "raw",
						"do": "req.user.password = req.user.password?1:0;req.user.paypassword=req.user.paypassword?1:0;",
						"send": "req.user"
					}
				],
				"midwares": ["auth"]
			},
			"user_get_invites": {
				"text": "获取用户邀请的用户列表"
			},
			"user_set_password": {
			},
			"user_set_paypassword": {
			}
		}
	},
	"impl": {
		"databases":{
			"main": {
				"withSchemas": [
					"record_user_signin",
					"record_sms",
					"smstpl",
					"smscode",
					"user",
					"channel",
					"session"
				]
			}
		},
		"servers": {
			"fserver": {
				"withApis": [
					"sms_send_signup",
					"sms_send_reg",
					"sms_verify",
					"session_add",
					"session_supp",
					"user_signin",
					"user_signup",
					"user_get",
					"user_get_invites",
					"user_set_password",
					"user_set_paypassword"
				]
			}
		}
	}
}
